<div class="w-full">
  <div class="mb-6 md:mb-8">
    <div class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-red-400 mb-4">ðŸŽ„ Mid-Winter Tree Tracker</h1>
      <%= link_to "New Entry", new_tree_entry_path, class: "inline-block px-6 py-3 text-base md:text-lg bg-green-600 text-white rounded-lg hover:bg-green-500 shadow-lg hover:shadow-xl transition-all font-semibold" %>
    </div>
  </div>

  <% unless current_family %>
    <div class="bg-yellow-900/60 border-2 border-yellow-600 text-yellow-200 px-4 py-3 rounded-lg mb-6 shadow-md">
      <p>You need to join or create a family to start tracking trees. <%= link_to "Go to Families", families_path, class: "underline font-semibold text-yellow-300 hover:text-yellow-100" %></p>
    </div>
  <% end %>

  <div class="mb-4 md:mb-6">
    <label class="block text-sm font-medium text-red-400 mb-2">Select Season:</label>
    <%= form_with url: dashboard_path, method: :get, local: true, class: "w-full md:w-auto" do |f| %>
      <%= select_tag :season_id, 
          options_from_collection_for_select(@all_seasons, :year, :year, @selected_season.year),
          { onchange: "this.form.submit()", class: "w-full md:w-auto px-3 md:px-4 py-2 border-2 border-green-500 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 text-sm md:text-base bg-gray-800 text-gray-100" } %>
    <% end %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
    <% if current_family %>
      <div class="border-2 border-green-500 rounded-lg p-4 md:p-6 bg-gradient-to-br from-gray-800 to-gray-900 shadow-lg">
        <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 text-green-400"><%= current_family.name %> Family Total</h2>
        <p class="text-3xl md:text-4xl font-bold text-green-300"><%= @family_total %></p>
        <p class="text-xs md:text-sm text-green-400 mt-2">trees collected in <%= @selected_season.year %></p>
      </div>
    <% end %>

    <div class="border-2 border-red-500 rounded-lg p-4 md:p-6 bg-gradient-to-br from-gray-800 to-gray-900 shadow-lg">
      <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 text-red-400">Overall Total - <%= @selected_season.year %></h2>
      <p class="text-3xl md:text-4xl font-bold text-red-300"><%= @overall_total %></p>
      <p class="text-xs md:text-sm text-red-400 mt-2">trees collected by all families</p>
      
      <% if @season_goal %>
        <div class="mt-4 md:mt-5 pt-3 md:pt-4 border-t border-gray-700">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-1 sm:gap-0 text-xs md:text-sm mb-2 text-red-300">
            <span class="font-medium">Season Goal: <%= @season_goal.goal_count %> trees</span>
            <span class="font-semibold text-base md:text-lg"><%= @overall_progress.round(1) %>% Complete</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-4 md:h-5 mb-3 shadow-inner">
            <div class="bg-gradient-to-r from-green-500 to-green-400 h-4 md:h-5 rounded-full shadow-md transition-all duration-300" style="width: <%= [@overall_progress, 100].min %>%"></div>
          </div>
          <% if current_user.any_family_admin? %>
            <div class="text-center mt-2">
              <%= link_to "âœï¸ Edit Goal", edit_season_goal_path(@season_goal), class: "inline-block px-4 py-2 text-sm md:text-base text-red-400 hover:text-red-300 hover:bg-red-900/30 rounded-lg font-semibold transition-all border border-red-500/50" %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="mt-4 md:mt-5 pt-3 md:pt-4 border-t border-gray-700">
          <p class="text-sm md:text-base font-medium text-gray-300 mb-3">ðŸŽ¯ No season goal set yet</p>
          <% if current_user.any_family_admin? %>
            <div class="bg-gray-800/50 border-2 border-red-500/50 rounded-lg p-3 md:p-4">
              <p class="text-xs md:text-sm text-gray-300 mb-3">Set a goal for all families this season:</p>
              <%= form_with url: season_goals_path, method: :post, local: true, class: "flex flex-col sm:flex-row gap-2" do |f| %>
                <%= hidden_field_tag :season_id, @selected_season.year %>
                <%= number_field_tag :goal_count, nil, placeholder: "Enter goal (e.g., 200)", min: 1, step: 1, class: "flex-1 px-4 py-3 border-2 border-gray-600 rounded-lg text-base bg-gray-900 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" %>
                <%= f.submit "Set Season Goal", class: "px-6 py-3 bg-red-600 text-white rounded-lg text-base hover:bg-red-500 whitespace-nowrap font-semibold shadow-md transition-all hover:shadow-lg" %>
              <% end %>
            </div>
          <% else %>
            <p class="text-xs md:text-sm text-gray-500 italic">Only family admins can set the season goal</p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <% if current_family %>
    <div class="mb-6 md:mb-8">
      <h2 class="text-xl md:text-2xl font-semibold mb-3 md:mb-4 text-red-400">Progress Chart</h2>
      <div class="border-2 border-green-500 rounded-lg p-3 md:p-6 bg-gradient-to-br from-gray-800 to-gray-900 shadow-lg overflow-x-auto">
        <% 
          family_entries_by_date = TreeEntry.for_season(@selected_season)
                                            .group_by { |e| e.entry_date }
                                            .map { |date, entries| [date.strftime("%Y-%m-%d"), entries.sum(&:tree_count)] }
                                            .sort_by { |date, _| date }
                                            .to_h
        %>
        <% if family_entries_by_date.any? %>
          <div class="min-w-0" style="min-width: 300px;">
            <%= line_chart family_entries_by_date, 
                height: "300px",
                colors: ['#22c55e'],
                library: { 
                  title: "Trees Collected Over Time",
                  titleTextStyle: { color: '#9CA3AF' },
                  hAxis: { title: "Date", textStyle: { color: '#9CA3AF' }, titleTextStyle: { color: '#9CA3AF' }, gridlines: { color: '#374151' } },
                  vAxis: { title: "Number of Trees", textStyle: { color: '#9CA3AF' }, titleTextStyle: { color: '#9CA3AF' }, gridlines: { color: '#374151' } },
                  backgroundColor: 'transparent',
                  legend: { textStyle: { color: '#9CA3AF' }, position: 'none' },
                  chartArea: { width: "70%", height: "70%" },
                  lineWidth: 3,
                  pointSize: 5
                } %>
          </div>
        <% else %>
          <p class="text-gray-400 text-center py-8">No entries yet for this season.</p>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mb-6 md:mb-8">
    <div class="border-2 border-red-500 rounded-lg p-4 md:p-6 bg-gradient-to-br from-gray-800 to-gray-900 shadow-lg">
      <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 text-red-400">Recent Entries (All Families)</h2>
      <% if @recent_entries.any? %>
        <div class="space-y-2">
          <% @recent_entries.each do |entry| %>
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-1 sm:gap-0 py-2 border-b border-gray-700">
              <div class="flex-1 min-w-0">
                <p class="font-medium text-sm md:text-base text-gray-100"><%= entry.entry_date.strftime("%B %d, %Y") %></p>
                <p class="text-xs md:text-sm text-gray-400 truncate">
                  <%= entry.family.name %> - <%= entry.user.email %>
                </p>
              </div>
              <p class="text-base md:text-lg font-semibold whitespace-nowrap text-green-300"><%= entry.tree_count %> trees</p>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-400 text-center py-6 md:py-8 text-sm md:text-base">No entries yet for this season.</p>
      <% end %>
    </div>
  </div>

  <div class="mb-6 md:mb-8">
    <h2 class="text-xl md:text-2xl font-semibold mb-3 md:mb-4 text-green-400">All Families Comparison</h2>
    <div class="border-2 border-green-500 rounded-lg p-3 md:p-6 bg-gradient-to-br from-gray-800 to-gray-900 shadow-lg overflow-x-auto">
      <% 
        family_totals = Family.joins(:tree_entries)
                             .where(tree_entries: { season: @selected_season })
                             .group('families.name')
                             .sum('tree_entries.tree_count')
      %>
      <% if family_totals.any? %>
        <div class="min-w-0" style="min-width: 300px;">
          <%= column_chart family_totals, 
              height: "300px",
              colors: ['#ef4444', '#22c55e', '#eab308', '#dc2626', '#16a34a'],
              library: { 
                title: "Family Totals for #{@selected_season.year}",
                titleTextStyle: { color: '#9CA3AF' },
                hAxis: { title: "Family", textStyle: { color: '#9CA3AF' }, titleTextStyle: { color: '#9CA3AF' }, gridlines: { color: '#374151' } },
                vAxis: { title: "Number of Trees", textStyle: { color: '#9CA3AF' }, titleTextStyle: { color: '#9CA3AF' }, gridlines: { color: '#374151' } },
                backgroundColor: 'transparent',
                legend: { textStyle: { color: '#9CA3AF' }, position: 'none' },
                chartArea: { width: "70%", height: "70%" },
                bar: { groupWidth: '60%' }
              } %>
        </div>
      <% else %>
        <p class="text-gray-400 text-center py-6 md:py-8 text-sm md:text-base">No entries yet for this season.</p>
      <% end %>
    </div>
  </div>
</div>
