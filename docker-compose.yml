version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mwtt-web
    command: ./bin/thrust ./bin/rails server
    environment:
      RAILS_ENV: production
      # Rails will use RAILS_MASTER_KEY env var if set, otherwise look for config/master.key file
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY:-}
      # Database connection - uses external PostgreSQL on host
      # Option 1: Use host.docker.internal (works on Docker Desktop and some Linux setups)
      DB_HOST: ${DB_HOST:-host.docker.internal}
      # Option 2: Use host's IP address (if host.docker.internal doesn't work)
      # DB_HOST: ${DB_HOST:-172.17.0.1}
      # Option 3: Use network_mode: host (see below) and set DB_HOST to localhost
      DB_USERNAME: ${DB_USERNAME:-mwtt}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT:-5432}
      # Or use full DATABASE_URL instead of individual variables
      # DATABASE_URL: postgresql://${DB_USERNAME:-mwtt}:${DB_PASSWORD}@${DB_HOST:-host.docker.internal}:${DB_PORT:-5432}/mwtt_production
    volumes:
      - storage_data:/rails/storage
      # Mount master.key file if you copied it to the server (Option A)
      # Uncomment the line below and ensure config/master.key exists on the host
      # - ./config/master.key:/rails/config/master.key:ro
    ports:
      - "80:80"
    # Option: Uncomment below to use host network (allows direct localhost access)
    # network_mode: host
    # If using network_mode: host, remove the ports section above
    restart: unless-stopped
    # Add extra_hosts if host.docker.internal doesn't work
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  storage_data:
    driver: local
