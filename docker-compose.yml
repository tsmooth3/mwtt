version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mwtt-web
    # Use rails server directly - it respects the PORT env var (Thrust defaults to port 80 which requires root)
    command: ./bin/rails server
    environment:
      RAILS_ENV: production
      # Rails will use RAILS_MASTER_KEY env var if set, otherwise look for config/master.key file
      # Since we're mounting master.key below, we don't need RAILS_MASTER_KEY env var
      # Uncomment the next line if you prefer using RAILS_MASTER_KEY from .env instead:
      # RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      # Port for the web server (defaults to 3000 if not set)
      PORT: ${PORT:-3000}
    volumes:
      # Mount storage directory for SQLite database and Active Storage files
      - ./storage:/rails/storage
      # Mount master.key file if you copied it to the server (Option A)
      - ./config/master.key:/rails/config/master.key:ro
    # Using host network mode to simplify database connections
    network_mode: host
    # Note: With host network, ports mapping is not needed (container uses host network directly)
    # ports:
    #   - "80:80"
    restart: unless-stopped

# No volumes needed - using bind mount for storage directory
